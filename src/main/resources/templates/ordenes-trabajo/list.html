<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section>
    <nav class="breadcrumbs" sec:authorize="isAuthenticated()">
        <a th:href="@{/}">Inicio</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">Órdenes de trabajo</span>
    </nav>
    <div class="page-header">
        <div class="page-header-content">
            <div>
                <h1>Órdenes de trabajo</h1>
                <p>Gestiona la operativa diaria y los trabajos en curso.</p>
            </div>
            <div class="page-header-actions">
                <a class="button success" th:href="@{/ordenes-trabajo/exportar(estado=${estadoSeleccionado})}"
                   sec:authorize="hasAnyRole('ADMIN','RECEPCION')">
                    <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exportar datos
                </a>
                <a class="button primary" th:href="@{/ordenes-trabajo/nueva}">
                    <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M12 5v14"/>
                        <path d="M5 12h14"/>
                    </svg>
                    Nueva OT
                </a>
            </div>
        </div>
        <div class="filters-section">
            <span class="filters-label">Filtrar por estado:</span>
            <div class="filters-group">
                <a class="button filter-btn" th:classappend="${estadoSeleccionado == null} ? ' active'" th:href="@{/ordenes-trabajo}">Todas</a>
                <a class="button filter-btn" th:each="estado : ${estados}"
                   th:classappend="${estadoSeleccionado == estado} ? ' active'"
                   th:href="@{/ordenes-trabajo(estado=${estado})}"
                   th:text="${estado.etiqueta}">Estado</a>
            </div>
        </div>
    </div>

    <div class="card table-card">
        <div class="table-wrap">
            <table class="table" id="ordenes-table">
                <thead>
                <tr>
                    <th>OT</th>
                    <th>Vehículo</th>
                    <th>Cliente</th>
                    <th>Asignado</th>
                    <th>Estado</th>
                    <th>Creación</th>
                    <th>Cierre</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr class="empty-state-row" th:if="${#lists.isEmpty(ordenes)}">
                    <td colspan="9">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                                </svg>
                            </div>
                            <h3>No hay órdenes de trabajo</h3>
                            <p>Crea tu primera orden de trabajo para comenzar a gestionar los trabajos del taller.</p>
                            <a class="button primary" th:href="@{/ordenes-trabajo/nueva}">
                                <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Crear primera orden
                            </a>
                        </div>
                    </td>
                </tr>
                <tr th:each="ot : ${ordenes}">
                    <td th:text="${ot.idOt}">1</td>
                    <td th:text="${ot.vehiculo != null ? ot.vehiculo.matricula : '-'}">Matrícula</td>
                    <td th:text="${ot.vehiculo != null && ot.vehiculo.cliente != null ? ot.vehiculo.cliente.nombre : '-'}">Cliente</td>
                    <td th:text="${ot.usuarioAsignado != null ? ot.usuarioAsignado.nombre : '-'}">Usuario</td>
                    <td>
                        <span class="badge"
                              th:classappend="' status-' + (ot.estado != null ? ot.estado.valor : 'abierta')"
                              th:text="${ot.estado != null ? ot.estado.etiqueta : 'Abierta'}">Estado</span>
                    </td>
                    <td th:text="${ot.fechaCreacionFormateada} ?: '-'">Fecha</td>
                    <td th:text="${ot.fechaCierreFormateada} ?: '-'">Fecha</td>
                    <td th:text="${ot.totalFormateado}">Total</td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <a class="icon-button edit" th:href="@{/ordenes-trabajo/{id}/editar(id=${ot.idOt})}"
                               data-tooltip="Editar" aria-label="Editar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M12 20h9"/>
                                    <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                                </svg>
                            </a>
                            <a class="button compact" th:href="@{/ordenes-trabajo/{id}/factura(id=${ot.idOt})}"
                               sec:authorize="hasAnyRole('ADMIN','RECEPCION')">Factura PDF</a>
                            <form class="inline delete-form" th:action="@{/ordenes-trabajo/{id}/eliminar(id=${ot.idOt})}" method="post"
                                  sec:authorize="hasAnyRole('ADMIN','RECEPCION')"
                                  th:data-numero="${ot.idOt}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button class="icon-button delete" type="submit" data-tooltip="Eliminar" aria-label="Eliminar">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M3 6h18"/>
                                        <path d="M8 6V4h8v2"/>
                                        <path d="M19 6l-1 14H6L5 6"/>
                                        <path d="M10 11v6"/>
                                        <path d="M14 11v6"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginación -->
    <div th:if="${totalItems > 0}" class="pagination">
        <div class="pagination-info" th:if="${totalItems > 0}">
            Mostrando <strong th:text="${currentPage * pageSize + 1}">1</strong> - 
            <strong th:text="${(currentPage * pageSize + pageSize) > totalItems ? totalItems : (currentPage * pageSize + pageSize)}">10</strong> 
            de <strong th:text="${totalItems}">0</strong> registros
        </div>
        <div class="pagination-info" th:if="${totalItems == 0}">
            No hay registros
        </div>
        
        <div class="pagination-controls" th:if="${totalPages > 1}">
            <a th:if="${currentPage > 2}" 
               th:href="@{/ordenes-trabajo(page=0, size=${pageSize}, estado=${estadoSeleccionado})}" 
               class="pagination-btn" aria-label="Primera página">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 18V6M6 6l6 6-6 6"/>
                </svg>
            </a>
            
            <a th:href="@{/ordenes-trabajo(page=${currentPage - 1}, size=${pageSize}, estado=${estadoSeleccionado})}" 
               class="pagination-btn" 
               th:classappend="${currentPage == 0} ? 'disabled'"
               aria-label="Página anterior">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </a>
            
            <th:block th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:if="${pageNum == 0 || pageNum == totalPages - 1 || (pageNum >= currentPage - 1 && pageNum <= currentPage + 1)}"
                   th:href="@{/ordenes-trabajo(page=${pageNum}, size=${pageSize}, estado=${estadoSeleccionado})}" 
                   class="pagination-btn"
                   th:classappend="${pageNum == currentPage} ? 'active'"
                   th:text="${pageNum + 1}">1</a>
                <span th:if="${pageNum == currentPage - 2 && currentPage > 3}" class="pagination-btn disabled">...</span>
                <span th:if="${pageNum == currentPage + 2 && currentPage < totalPages - 4}" class="pagination-btn disabled">...</span>
            </th:block>
            
            <a th:href="@{/ordenes-trabajo(page=${currentPage + 1}, size=${pageSize}, estado=${estadoSeleccionado})}" 
               class="pagination-btn" 
               th:classappend="${currentPage >= totalPages - 1} ? 'disabled'"
               aria-label="Página siguiente">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
            
            <a th:if="${currentPage < totalPages - 3}"
               th:href="@{/ordenes-trabajo(page=${totalPages - 1}, size=${pageSize}, estado=${estadoSeleccionado})}" 
               class="pagination-btn" 
               th:classappend="${currentPage >= totalPages - 1} ? 'disabled'"
               aria-label="Última página">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 6v12M18 18l-6-6 6-6"/>
                </svg>
            </a>
        </div>
        
        <div class="pagination-size-selector">
            <label for="pageSize-ordenes">Mostrar:</label>
            <select id="pageSize-ordenes" onchange="changePageSize(this.value)">
                <option value="5" th:selected="${pageSize == 5}">5</option>
                <option value="10" th:selected="${pageSize == 10}">10</option>
                <option value="25" th:selected="${pageSize == 25}">25</option>
                <option value="50" th:selected="${pageSize == 50}">50</option>
                <option value="100" th:selected="${pageSize == 100}">100</option>
            </select>
        </div>
    </div>

    <script th:src="@{/js/list-search.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar búsqueda
            new ListSearch('#ordenes-table', 'Buscar por OT, vehículo, cliente, estado...');
            
            // Manejar eliminación
            const deleteForms = document.querySelectorAll('.delete-form');
            deleteForms.forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const numero = form.dataset.numero || 'esta orden';
                    const confirmed = await confirmDelete(
                        '¿Eliminar orden de trabajo?',
                        `¿Estás seguro de que deseas eliminar la orden de trabajo #${numero}? Esta acción no se puede deshacer y se perderán todos los datos.`
                    );
                    if (confirmed) {
                        form.submit();
                    }
                });
            });
        });
    </script>
</section>
</html>
