<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section>
    <nav class="breadcrumbs" sec:authorize="isAuthenticated()">
        <a th:href="@{/}">Inicio</a>
        <span class="breadcrumb-separator">/</span>
        <a th:href="@{/ordenes-trabajo}">Órdenes de trabajo</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current" th:text="${isEdit} ? 'Editar' : 'Nueva'">Formulario</span>
    </nav>
    <div class="page-header">
        <div>
            <h1 th:text="${isEdit} ? 'Editar orden de trabajo' : 'Nueva orden de trabajo'">Formulario</h1>
            <p th:text="${isEdit} ? 'Modifica los datos de la orden de trabajo' : 'Crea una nueva orden de trabajo en el taller'">
                Descripción del formulario
            </p>
        </div>
        <a class="button" th:href="@{/ordenes-trabajo}">
            <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Volver
        </a>
    </div>

    <div class="card form-card">
        <form th:action="@{${action}}" th:object="${ordenTrabajo}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            
            <div class="form-section">
                <div class="form-section-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 17h14v-4H5z"/>
                        <path d="M19 3H5C3.9 3 3 3.9 3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                    </svg>
                    <h3>Información del vehículo</h3>
                </div>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="form-label" for="vehiculo">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 17h14v-4H5z"/>
                                <rect x="3" y="5" width="18" height="14" rx="2"/>
                            </svg>
                            Vehículo
                            <span class="required">*</span>
                        </label>
                        <select id="vehiculo" class="form-select" th:field="*{vehiculo.idVehiculo}" required>
                            <option value="" disabled
                                    th:selected="${ordenTrabajo.vehiculo == null || ordenTrabajo.vehiculo.idVehiculo == null}">
                                -- Selecciona el vehículo --
                            </option>
                            <option th:each="vehiculo : ${vehiculos}"
                                    th:value="${vehiculo.idVehiculo}"
                                    th:attr="data-km=${vehiculo.kmActual != null ? vehiculo.kmActual : 0}"
                                    th:text="${vehiculo.matricula + ' - ' + (vehiculo.cliente != null ? vehiculo.cliente.nombre : '')}">
                                Vehículo
                            </option>
                        </select>
                        <span class="form-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Matrícula y propietario del vehículo
                        </span>
                        <div class="form-error" th:if="${#fields.hasErrors('vehiculo')}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4M12 16h.01"/>
                            </svg>
                            <span th:errors="*{vehiculo}">Error</span>
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label" for="kmEntrada">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Kilometraje de entrada
                        </label>
                        <div class="input-icon-group">
                            <input id="kmEntrada" type="number" class="form-input with-addon" th:field="*{kmEntrada}" 
                                   min="0" step="1" placeholder="Ej: 75000">
                            <span class="input-addon">km</span>
                        </div>
                        <span class="form-hint" id="kmEntrada-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Kilometraje al entrar al taller. Mínimo según el vehículo seleccionado.
                        </span>
                        <div class="form-error" th:if="${#fields.hasErrors('kmEntrada')}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4M12 16h.01"/>
                            </svg>
                            <span th:errors="*{kmEntrada}">Error</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <path d="M20 8v6M23 11h-6"/>
                    </svg>
                    <h3>Asignación y estado</h3>
                </div>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="form-label" for="usuarioAsignado">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            Mecánico asignado
                        </label>
                        <select id="usuarioAsignado" class="form-select" th:field="*{usuarioAsignado.idUsuario}">
                            <option value="" th:selected="${ordenTrabajo.usuarioAsignado == null || ordenTrabajo.usuarioAsignado.idUsuario == null}">
                                -- Sin asignar --
                            </option>
                            <option th:each="usuario : ${usuarios}"
                                    th:value="${usuario.idUsuario}"
                                    th:text="${usuario.nombre}">
                                Usuario
                            </option>
                        </select>
                        <span class="form-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Opcional, puedes asignar después
                        </span>
                    </div>

                    <div class="form-field">
                        <label class="form-label" for="estado">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Estado de la orden
                            <span class="required">*</span>
                        </label>
                        <select id="estado" class="form-select" th:field="*{estado}" required>
                            <option th:each="estado : ${estados}"
                                    th:value="${estado}"
                                    th:text="${estado.etiqueta}">
                                Estado
                            </option>
                        </select>
                        <div class="form-error" th:if="${#fields.hasErrors('estado')}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4M12 16h.01"/>
                            </svg>
                            <span th:errors="*{estado}">Error</span>
                        </div>
                    </div>

                    <div class="form-field full-width">
                        <label class="form-label" for="fechaCierre">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <path d="M16 2v4M8 2v4M3 10h18"/>
                            </svg>
                            Fecha de cierre
                        </label>
                        <input id="fechaCierre" type="datetime-local" class="form-input" th:field="*{fechaCierre}">
                        <span class="form-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Se establece automáticamente al marcar como "Entregada"
                        </span>
                        <div class="form-error" th:if="${#fields.hasErrors('fechaCierre')}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4M12 16h.01"/>
                            </svg>
                            <span th:errors="*{fechaCierre}">Error</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    <h3>Descripción del trabajo</h3>
                </div>
                <div class="form-grid single-col">
                    <div class="form-field">
                        <label class="form-label" for="descripcion">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Descripción de la reparación
                        </label>
                        <textarea id="descripcion" class="form-textarea" th:field="*{descripcion}" rows="5" 
                                  placeholder="Describe detalladamente el trabajo a realizar o realizado..."></textarea>
                        <span class="form-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Detalla piezas, mano de obra y cualquier observación relevante
                        </span>
                        <div class="form-error" th:if="${#fields.hasErrors('descripcion')}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4M12 16h.01"/>
                            </svg>
                            <span th:errors="*{descripcion}">Error</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <h3>Facturación</h3>
                </div>
                <div class="form-grid">
                    <div class="form-field">
                        <label class="form-label" for="subtotal">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Subtotal (sin IVA)
                        </label>
                        <div class="input-icon-group">
                            <input id="subtotal" type="number" class="form-input with-addon" th:field="*{subtotal}" 
                                   step="0.01" min="0" placeholder="0.00">
                            <span class="input-addon">€</span>
                        </div>
                        <span class="form-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Importe antes de impuestos
                        </span>
                        <div class="form-error" th:if="${#fields.hasErrors('subtotal')}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4M12 16h.01"/>
                            </svg>
                            <span th:errors="*{subtotal}">Error</span>
                        </div>
                    </div>

                    <div class="form-field">
                        <label class="form-label" for="ivaTotal">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <path d="M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            IVA (21%)
                        </label>
                        <div class="input-icon-group">
                            <input id="ivaTotal" type="number" class="form-input with-addon" th:field="*{ivaTotal}" 
                                   step="0.01" min="0" readonly placeholder="0.00">
                            <span class="input-addon">€</span>
                        </div>
                        <span class="form-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Calculado automáticamente (21% del subtotal)
                        </span>
                        <div class="form-error" th:if="${#fields.hasErrors('ivaTotal')}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4M12 16h.01"/>
                            </svg>
                            <span th:errors="*{ivaTotal}">Error</span>
                        </div>
                    </div>

                    <div class="form-field full-width">
                        <label class="form-label" for="total">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Total a pagar
                        </label>
                        <div class="input-icon-group">
                            <input id="total" type="number" class="form-input with-addon" th:field="*{total}" 
                                   step="0.01" min="0" readonly placeholder="0.00" 
                                   style="font-weight: 700; font-size: 1.1rem;">
                            <span class="input-addon" style="font-weight: 700;">€</span>
                        </div>
                        <span class="form-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Importe total con IVA incluido
                        </span>
                        <div class="form-error" th:if="${#fields.hasErrors('total')}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4M12 16h.01"/>
                            </svg>
                            <span th:errors="*{total}">Error</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button class="button primary" type="submit">
                    <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <path d="M17 21v-8H7v8M7 3v5h8"/>
                    </svg>
                    <span th:text="${isEdit} ? 'Guardar cambios' : 'Crear orden de trabajo'">Guardar</span>
                </button>
                <a class="button" th:href="@{/ordenes-trabajo}">Cancelar</a>
            </div>
        </form>
    </div>

    <script th:src="@{/js/ordenes-trabajo.js}"></script>
</section>
</html>
