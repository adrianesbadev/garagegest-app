<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section>
    <nav class="breadcrumbs" sec:authorize="isAuthenticated()">
        <a th:href="@{/}">Inicio</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">Vehículos</span>
    </nav>
    <div class="page-header">
        <div>
            <h1>Vehículos</h1>
            <p>Controla la flota registrada y su información técnica.</p>
        </div>
        <div class="form-actions">
            <a class="button success" th:href="@{/vehiculos/exportar}">
                <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Exportar datos
            </a>
            <a class="button primary" th:href="@{/vehiculos/nuevo}">
                <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 5v14"/>
                    <path d="M5 12h14"/>
                </svg>
                Nuevo vehículo
            </a>
        </div>
    </div>

    <div class="card table-card">
        <div class="table-wrap">
            <table class="table" id="vehiculos-table">
                <thead>
                <tr>
                    <th>Matrícula</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>Año</th>
                    <th>Km</th>
                    <th>Cliente</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr class="empty-state-row" th:if="${#lists.isEmpty(vehiculos)}">
                    <td colspan="7">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="10" width="18" height="7" rx="2"/>
                                    <path d="M6 10l2-3h8l2 3"/>
                                    <circle cx="8" cy="17" r="1.5"/>
                                    <circle cx="16" cy="17" r="1.5"/>
                                </svg>
                            </div>
                            <h3>No hay vehículos registrados</h3>
                            <p>Registra el primer vehículo para comenzar a gestionar la flota de tu taller.</p>
                            <a class="button primary" th:href="@{/vehiculos/nuevo}">
                                <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Añadir primer vehículo
                            </a>
                        </div>
                    </td>
                </tr>
                <tr th:each="vehiculo : ${vehiculos}">
                    <td th:text="${vehiculo.matricula}">Matrícula</td>
                    <td th:text="${vehiculo.marca} ?: '-'">Marca</td>
                    <td th:text="${vehiculo.modelo} ?: '-'">Modelo</td>
                    <td th:text="${vehiculo.anio} ?: '-'">Año</td>
                    <td th:text="${vehiculo.kmActual} ?: '-'">Km</td>
                    <td th:text="${vehiculo.cliente != null ? vehiculo.cliente.nombre : '-'}">Cliente</td>
                    <td>
                        <div class="action-buttons">
                            <a class="button" th:href="@{/vehiculos/{id}(id=${vehiculo.idVehiculo})}">Ver</a>
                            <a class="icon-button edit" th:href="@{/vehiculos/{id}/editar(id=${vehiculo.idVehiculo})}"
                               data-tooltip="Editar" aria-label="Editar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                     stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M12 20h9"/>
                                    <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                                </svg>
                            </a>
                            <form class="inline delete-form" th:action="@{/vehiculos/{id}/eliminar(id=${vehiculo.idVehiculo})}" method="post"
                                  th:data-matricula="${vehiculo.matricula}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button class="icon-button delete" type="submit" data-tooltip="Eliminar" aria-label="Eliminar">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M3 6h18"/>
                                        <path d="M8 6V4h8v2"/>
                                        <path d="M19 6l-1 14H6L5 6"/>
                                        <path d="M10 11v6"/>
                                        <path d="M14 11v6"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginación -->
    <div th:if="${totalItems > 0}" class="pagination">
        <div class="pagination-info" th:if="${totalItems > 0}">
            Mostrando <strong th:text="${currentPage * pageSize + 1}">1</strong> - 
            <strong th:text="${(currentPage * pageSize + pageSize) > totalItems ? totalItems : (currentPage * pageSize + pageSize)}">10</strong> 
            de <strong th:text="${totalItems}">0</strong> registros
        </div>
        <div class="pagination-info" th:if="${totalItems == 0}">
            No hay registros
        </div>
        
        <div class="pagination-controls" th:if="${totalPages > 1}">
            <a th:if="${currentPage > 2}" th:href="@{/vehiculos(page=0, size=${pageSize})}" 
               class="pagination-btn" aria-label="Primera página">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 18V6M6 6l6 6-6 6"/>
                </svg>
            </a>
            
            <a th:href="@{/vehiculos(page=${currentPage - 1}, size=${pageSize})}" 
               class="pagination-btn" 
               th:classappend="${currentPage == 0} ? 'disabled'"
               aria-label="Página anterior">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </a>
            
            <th:block th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:if="${pageNum == 0 || pageNum == totalPages - 1 || (pageNum >= currentPage - 1 && pageNum <= currentPage + 1)}"
                   th:href="@{/vehiculos(page=${pageNum}, size=${pageSize})}" 
                   class="pagination-btn"
                   th:classappend="${pageNum == currentPage} ? 'active'"
                   th:text="${pageNum + 1}">1</a>
                <span th:if="${pageNum == currentPage - 2 && currentPage > 3}" class="pagination-btn disabled">...</span>
                <span th:if="${pageNum == currentPage + 2 && currentPage < totalPages - 4}" class="pagination-btn disabled">...</span>
            </th:block>
            
            <a th:href="@{/vehiculos(page=${currentPage + 1}, size=${pageSize})}" 
               class="pagination-btn" 
               th:classappend="${currentPage >= totalPages - 1} ? 'disabled'"
               aria-label="Página siguiente">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
            
            <a th:if="${currentPage < totalPages - 3}"
               th:href="@{/vehiculos(page=${totalPages - 1}, size=${pageSize})}" 
               class="pagination-btn" 
               th:classappend="${currentPage >= totalPages - 1} ? 'disabled'"
               aria-label="Última página">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 6v12M18 18l-6-6 6-6"/>
                </svg>
            </a>
        </div>
        
        <div class="pagination-size-selector">
            <label for="pageSize-vehiculos">Mostrar:</label>
            <select id="pageSize-vehiculos" onchange="changePageSize(this.value)">
                <option value="5" th:selected="${pageSize == 5}">5</option>
                <option value="10" th:selected="${pageSize == 10}">10</option>
                <option value="25" th:selected="${pageSize == 25}">25</option>
                <option value="50" th:selected="${pageSize == 50}">50</option>
                <option value="100" th:selected="${pageSize == 100}">100</option>
            </select>
        </div>
    </div>

    <script th:src="@{/js/list-search.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar búsqueda
            new ListSearch('#vehiculos-table', 'Buscar por matrícula, marca, modelo, cliente...');
            
            // Manejar eliminación
            const deleteForms = document.querySelectorAll('.delete-form');
            deleteForms.forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const matricula = form.dataset.matricula || 'este vehículo';
                    const confirmed = await confirmDelete(
                        '¿Eliminar vehículo?',
                        `¿Estás seguro de que deseas eliminar el vehículo ${matricula}? Esta acción no se puede deshacer y se eliminarán todos los datos relacionados.`
                    );
                    if (confirmed) {
                        form.submit();
                    }
                });
            });
        });
    </script>
</section>
</html>
